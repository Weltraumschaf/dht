<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Server.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">DHT</a> &gt; <a href="index.source.html" class="el_package">de.weltraumschaf.dht.server</a> &gt; <span class="el_source">Server.java</span></div><h1>Server.java</h1><pre class="source lang-java linenums">/*
 *  LICENSE
 *
 * &quot;THE BEER-WARE LICENSE&quot; (Revision 43):
 * &quot;Sven Strittmatter&quot; &lt;weltraumschaf@googlemail.com&gt; wrote this file.
 * As long as you retain this notice you can do whatever you want with
 * this stuff. If we meet some day, and you think this stuff is worth it,
 * you can buy me a non alcohol-free beer in return.
 *
 * Copyright (C) 2012 &quot;Sven Strittmatter&quot; &lt;weltraumschaf@googlemail.com&gt;
 */
package de.weltraumschaf.dht.server;

import de.weltraumschaf.commons.IO;
import de.weltraumschaf.dht.msg.MessageBox;
import java.io.IOException;
import java.net.InetSocketAddress;
import java.nio.channels.AsynchronousServerSocketChannel;
import java.nio.channels.AsynchronousSocketChannel;
import java.nio.channels.CompletionHandler;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import org.apache.commons.lang3.Validate;

/**
 * Consider using https://github.com/netty/netty/tree/master/example/src/main/java/io/netty/example/echo
 *
 * @author Sven Strittmatter &lt;weltraumschaf@googlemail.com&gt;
 */
public final class Server {

    private static final int TIME_FACTOR = 1000;
    private static final int MAX_WAIT_COUNT = 5;
    private static final int MAX_BACK_LOG = 100;
    private static final int THREAD_POOL_SIZE = 1;

    private final IO io;
    private final MessageBox inbox;
<span class="nc" id="L39">    private final ConnectionQueue&lt;AsynchronousSocketChannel&gt; queue = new ConnectionQueue&lt;AsynchronousSocketChannel&gt;();</span>

    private ExecutorService workerService;
<span class="nc" id="L42">    private String host = null;</span>
<span class="nc" id="L43">    private int port = -1;</span>
    private Task worker;
    private AsynchronousServerSocketChannel server;

    private volatile int waitCount;

<span class="nc" id="L49">    private volatile State state = State.NOT_RUNNING;</span>

    public Server(final IO io, final MessageBox inbox) {
<span class="nc" id="L52">        super();</span>
<span class="nc" id="L53">        this.io = Validate.notNull(io, &quot;Parameter &gt;io&lt; must not be null!&quot;);</span>
<span class="nc" id="L54">        this.inbox = Validate.notNull(inbox, &quot;Parameter &gt;inbox&lt; must not be null!&quot;);</span>
<span class="nc" id="L55">    }</span>

    public void setHost(final String host) {
<span class="nc" id="L58">        this.host = Validate.notEmpty(host, &quot;Parameter &gt;host&lt; must not be null or empty!&quot;);</span>
<span class="nc" id="L59">    }</span>

    public void setPort(final int port) {
<span class="nc" id="L62">        Validate.isTrue(PortValidator.isValid(port),</span>
            String.format(&quot;Parameter &gt;port&lt; must be in range %s! Given &gt;%d&lt;.&quot;, PortValidator.range(), port));
<span class="nc" id="L64">        this.port = port;</span>
<span class="nc" id="L65">    }</span>

    public void start() throws IOException {
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (null == host) {</span>
<span class="nc" id="L69">            throw new IllegalStateException(&quot;Host not set!&quot;);</span>
        }

<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (-1 == port) {</span>
<span class="nc" id="L73">            throw new IllegalStateException(&quot;Port not set!&quot;);</span>
        }

<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (state != State.NOT_RUNNING) {</span>
<span class="nc" id="L77">            throw new IllegalStateException(&quot;Server not in state NOT_RUNNING!&quot;);</span>
        }

<span class="nc" id="L80">        state = State.STARTING;</span>

<span class="nc" id="L82">        queue.clear();</span>
<span class="nc" id="L83">        worker = new RequestWorker(queue, io, inbox);</span>
<span class="nc" id="L84">        workerService = Executors.newFixedThreadPool(THREAD_POOL_SIZE);</span>
<span class="nc" id="L85">        workerService.execute(worker);</span>

<span class="nc" id="L87">        server = AsynchronousServerSocketChannel.open().bind(new InetSocketAddress(host, port), MAX_BACK_LOG);</span>
<span class="nc" id="L88">        server.accept(null, new CompletionHandler&lt;AsynchronousSocketChannel, Void&gt;() {</span>
            @Override
            public void completed(final AsynchronousSocketChannel ch, final Void att) {
                // accept the next connection
<span class="nc" id="L92">                server.accept(null, this);</span>
<span class="nc" id="L93">                queue.put(ch);</span>
<span class="nc" id="L94">            }</span>

            @Override
            public void failed(final Throwable t, final Void att) {
<span class="nc" id="L98">                io.println(&quot;Connection failed:  &quot; + t.getMessage());</span>
<span class="nc" id="L99">            }</span>
        });

<span class="nc" id="L102">        state = State.RUNNING;</span>
<span class="nc" id="L103">    }</span>

    public void stop() throws IOException, InterruptedException {
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (state != State.RUNNING) {</span>
<span class="nc" id="L107">            throw new IllegalStateException(&quot;Server is not in state RUNNING!&quot;);</span>
        }

<span class="nc" id="L110">        state = State.STOPPING;</span>
<span class="nc" id="L111">        server.close();</span>
<span class="nc" id="L112">        workerService.shutdown();</span>
<span class="nc" id="L113">        worker.stop();</span>

        while (true) {
<span class="nc bnc" id="L116" title="All 2 branches missed.">            if (worker.isReady()) {</span>
<span class="nc" id="L117">                break;</span>
            }

<span class="nc bnc" id="L120" title="All 2 branches missed.">            if (waitCount == MAX_WAIT_COUNT) {</span>
<span class="nc" id="L121">                io.println(String.format(&quot;Max. wait %d reached! Aborting ...&quot;, MAX_WAIT_COUNT));</span>
<span class="nc" id="L122">                break;</span>
            }

<span class="nc" id="L125">            final int wait = calculateTimeout(waitCount);</span>
<span class="nc" id="L126">            io.println(String.format(&quot;Waiting for worker task to be ready (%ds) ...&quot;, wait / TIME_FACTOR));</span>
<span class="nc" id="L127">            Thread.sleep(wait);</span>
<span class="nc" id="L128">            ++waitCount;</span>
<span class="nc" id="L129">        }</span>

<span class="nc" id="L131">        worker = null;</span>
<span class="nc" id="L132">        workerService = null;</span>

<span class="nc" id="L134">        state = State.NOT_RUNNING;</span>
<span class="nc" id="L135">    }</span>

    public boolean isRunning() {
<span class="nc bnc" id="L138" title="All 2 branches missed.">        return state == State.RUNNING;</span>
    }

    public State getState() {
<span class="nc" id="L142">        return state;</span>
    }

    static int calculateTimeout(final int round) {
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">        Validate.isTrue(round &gt; -1, &quot;Parameter &gt;round&lt; must be greater than -1!&quot;);</span>
<span class="fc" id="L147">        return TIME_FACTOR * (int) Math.pow(2, round);</span>
    }

    public int countQueue() {
<span class="nc" id="L151">        return queue.size();</span>
    }

<span class="nc" id="L154">    public static enum State {</span>

<span class="nc" id="L156">        NOT_RUNNING, RUNNING, STARTING, STOPPING;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.5.201403032054</span></div></body></html>